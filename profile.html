<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#6C63FF">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title data-i18n="seo.profile.title">ä¸ªäººä¸­å¿ƒ - GameTopUp</title>
  <meta name="description" data-i18n="seo.profile.desc" content="ç®¡ç†ä½ çš„è´¦æˆ·ä¿¡æ¯å’Œè®¾ç½®">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- ç»Ÿä¸€é…ç½®æ–‡ä»¶ -->
  <script src="config.js"></script>
  
  <!-- å¤šè¯­è¨€æ”¯æŒ -->
  <script src="translations.js"></script>
  <script src="i18n.js"></script>
  
  <!-- SEO åŠ è½½å™¨ -->
  <script src="seo-loader.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-color: #6C63FF;
      --secondary-color: #FF6584;
      --accent-color: #36D1DC;
      --dark-color: #1A1A2E;
      --light-color: #F8F9FA;
      --success-color: #28A745;
      --text-dark: #333;
      --text-light: #666;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 20px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --bg-color: #F8F9FA;
      --card-bg: #FFFFFF;
    }
    [data-theme="dark"] {
      --bg-color: #1A1A2E;
      --card-bg: #16213E;
      --text-dark: #E8E8E8;
      --text-light: #A0A0A0;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
      --shadow-lg: 0 10px 20px rgba(0,0,0,0.3);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-dark);
      line-height: 1.6;
      padding-bottom: 70px;
      transition: background-color 0.3s, color 0.3s;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
    .header {
      background: var(--card-bg);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow-sm);
      transition: background-color 0.3s;
    }
    .header-title {
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
    }
    .user-card {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border-radius: var(--radius-lg);
      padding: 30px 20px;
      margin: 20px;
      color: white;
      text-align: center;
      box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
      transition: background 0.3s;
    }
    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: white;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin: 0 auto 15px;
      font-weight: 700;
    }
    .user-name {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    .user-id {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 15px;
    }
    .login-btn {
      padding: 8px 30px;
      background: white;
      color: var(--primary-color);
      border: none;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .login-form {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin: 20px;
      box-shadow: var(--shadow-md);
      display: none;
      transition: background-color 0.3s;
    }
    .login-form.show { display: block; }
    .input-group { margin-bottom: 15px; }
    .input-field {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--radius-md);
      font-size: 1rem;
      background: var(--card-bg);
      color: var(--text-dark);
      transition: border-color 0.3s;
    }
    .input-field:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .submit-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .submit-btn:hover {
      background: #5a52d5;
      transform: translateY(-2px);
    }
    .forgot-link {
      text-align: center;
      margin-top: 15px;
      color: var(--text-light);
      font-size: 0.9rem;
    }
    .forgot-link a {
      color: var(--primary-color);
      text-decoration: none;
    }
    .register-link {
      text-align: center;
      margin-top: 10px;
      color: var(--text-light);
      font-size: 0.9rem;
    }
    .register-link a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px;
    }
    .stat-card {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 20px 15px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: background-color 0.3s, transform 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-size: 1.3rem;
    }
    .stat-icon.orders { background: #e3f2fd; color: #1976d2; }
    .stat-icon.spent { background: #fff3e0; color: #f57c00; }
    .stat-icon.saved { background: #e8f5e9; color: #388e3c; }
    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 0.8rem;
      color: var(--text-light);
    }
    .menu-list {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      margin: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: background-color 0.3s;
    }
    .menu-item {
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.3s;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:hover { background: #f8f9fa; }
    .menu-left { display: flex; align-items: center; gap: 15px; }
    .menu-icon {
      width: 35px;
      height: 35px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .menu-icon.orders { background: #e3f2fd; color: #1976d2; }
    .menu-icon.support { background: #fff3e0; color: #f57c00; }
    .menu-icon.settings { background: #f3e5f5; color: #7b1fa2; }
    .menu-text {
      font-weight: 500;
      color: var(--text-dark);
    }
    .menu-arrow { color: var(--text-light); }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: background-color 0.3s;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--text-light);
      cursor: pointer;
      padding: 5px 15px;
      transition: color 0.3s;
    }
    .nav-item.active { color: var(--primary-color); }
    .nav-item i { font-size: 1.2rem; }
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      padding: 15px 30px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 2000;
      display: none;
      animation: slideDown 0.3s ease-out;
    }
    .toast.show { display: block; }
    .toast.success { background: #e8f5e9; color: #2e7d32; }
    .toast.error { background: #ffebee; color: #c62828; }
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- å¤´éƒ¨ -->
  <header class="header">
    <div class="container">
      <div class="header-title" data-i18n="profile.title">ä¸ªäººä¸­å¿ƒ</div>
    </div>
  </header>

  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <div class="user-card" id="userCard">
    <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
    <div class="user-name" id="userName" data-i18n="profile.notLoggedIn">æœªç™»å½•</div>
    <div class="user-id" id="userId" data-i18n="profile.loggedIn.desc">ç™»å½•åäº«å—ä¸“å±æœåŠ¡</div>
    <button class="login-btn" id="loginBtn" onclick="showLogin()" data-i18n="profile.login.btn">ç«‹å³ç™»å½•</button>
    <button class="login-btn" id="logoutBtn" onclick="logout()" style="display: none; background: #ffebee; color: #c62828;" data-i18n="profile.logout.btn">é€€å‡ºç™»å½•</button>
  </div>

  <!-- ç™»å½•è¡¨å• -->
  <div class="login-form" id="loginForm">
    <div class="input-group">
      <input type="email" class="input-field" id="loginEmail" data-i18n="profile.login.email" placeholder="è¯·è¾“å…¥é‚®ç®±">
    </div>
    <div class="input-group">
      <input type="password" class="input-field" id="loginPassword" data-i18n="profile.login.password" placeholder="è¯·è¾“å…¥å¯†ç ">
    </div>
    <button class="submit-btn" onclick="submitLogin()" data-i18n="common.login">ç™»å½•</button>
    <div class="forgot-link">
      <a href="#" onclick="showComingSoon()" data-i18n="profile.login.forgot">å¿˜è®°å¯†ç ï¼Ÿ</a>
    </div>
    <div class="register-link">
      è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="register.html" data-i18n="profile.register.link">ç«‹å³æ³¨å†Œ</a>
    </div>
  </div>

  <!-- æ•°æ®ç»Ÿè®¡ -->
  <div class="stats-grid" id="statsGrid" style="display: none;">
    <div class="stat-card">
      <div class="stat-icon orders"><i class="fas fa-receipt"></i></div>
      <div class="stat-value" id="statOrders">0</div>
      <div class="stat-label" data-i18n="profile.stats.orders">æ€»è®¢å•</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon spent"><i class="fas fa-coins"></i></div>
      <div class="stat-value" id="statSpent">Â¥0</div>
      <div class="stat-label" data-i18n="profile.stats.spent">ç´¯è®¡å……å€¼</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon saved"><i class="fas fa-piggy-bank"></i></div>
      <div class="stat-value" id="statSaved">Â¥0</div>
      <div class="stat-label" data-i18n="profile.stats.saved">èŠ‚çœé‡‘é¢</div>
    </div>
  </div>

  <!-- åŠŸèƒ½èœå• -->
  <div class="menu-list">
    <div class="menu-item" onclick="window.location.href='orders.html'">
      <div class="menu-left">
        <div class="menu-icon orders"><i class="fas fa-receipt"></i></div>
        <div class="menu-text" data-i18n="profile.menu.orders">æˆ‘çš„è®¢å•</div>
      </div>
      <div class="menu-arrow"><i class="fas fa-chevron-right"></i></div>
    </div>
    <div class="menu-item" onclick="window.location.href='chat.html'">
      <div class="menu-left">
        <div class="menu-icon support"><i class="fas fa-headset"></i></div>
        <div class="menu-text" data-i18n="profile.menu.support">å®¢æœæ”¯æŒ</div>
      </div>
      <div class="menu-arrow"><i class="fas fa-chevron-right"></i></div>
    </div>
    <div class="menu-item" onclick="window.location.href='settings.html'">
      <div class="menu-left">
        <div class="menu-icon settings"><i class="fas fa-cog"></i></div>
        <div class="menu-text" data-i18n="profile.menu.settings">è®¾ç½®</div>
      </div>
      <div class="menu-arrow"><i class="fas fa-chevron-right"></i></div>
    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="bottom-nav">
    <div class="nav-item" onclick="window.location.href='index.html'">
      <i class="fas fa-home"></i>
      <span data-i18n="nav.home">é¦–é¡µ</span>
    </div>
    <div class="nav-item" onclick="window.location.href='cart.html'">
      <i class="fas fa-shopping-cart"></i>
      <span data-i18n="common.cart">è´­ç‰©è½¦</span>
    </div>
    <div class="nav-item" onclick="window.location.href='orders.html'">
      <i class="fas fa-file-alt"></i>
      <span data-i18n="common.orders">è®¢å•</span>
    </div>
    <div class="nav-item active">
      <i class="fas fa-user"></i>
      <span data-i18n="common.profile">æˆ‘çš„</span>
    </div>
  </nav>

  <!-- æ¶ˆæ¯æç¤º -->
  <div class="toast" id="toast"></div>

  <script>
    let currentUser = null;

    // åˆå§‹åŒ–é¡µé¢
    async function initPage() {
      // ğŸ” å…³é”®ï¼šç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ· session
      const { data: { session }, error: sessionError } = await db.auth.getSession();
      
      if (sessionError) {
        console.error('è·å– session å¤±è´¥:', sessionError);
        return;
      }
      
      if (session && session.user) {
        currentUser = session.user;
        console.log('âœ… å½“å‰ç”¨æˆ·:', currentUser.id);
        updateUserInfo();
        await loadStats();  // ğŸ” åŠ è½½ç»Ÿè®¡å‰ç¡®ä¿ç”¨æˆ·å·²è®¤è¯
      }
      
      // æ·±è‰²æ¨¡å¼
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      // å¤šè¯­è¨€
      if (typeof applyLanguage === 'function') {
        applyLanguage();
      }
    }

    // æ˜¾ç¤ºç™»å½•è¡¨å•
    window.showLogin = function() {
      document.getElementById('loginForm').classList.add('show');
      document.getElementById('loginBtn').style.display = 'none';
    };

    // æäº¤ç™»å½•
    window.submitLogin = async function() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showToast('âš ï¸ è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
        return;
      }

      const { data, error } = await db.auth.signInWithPassword({ email, password });
      
      if (error) {
        showToast(t('notify.login.failed') + ': ' + error.message, 'error');
        return;
      }

      currentUser = data.user;
      document.getElementById('loginForm').classList.remove('show');
      updateUserInfo();
      await loadStats();
      showToast(t('notify.login.success'), 'success');
    };

    // é€€å‡ºç™»å½•
    window.logout = async function() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        await db.auth.signOut();
        currentUser = null;
        location.reload();
      }
    };

    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    function updateUserInfo() {
      if (!currentUser) return;

      const email = currentUser.email;
      const username = currentUser.user_metadata?.username || email.split('@')[0];
      
      document.getElementById('userName').textContent = username;
      document.getElementById('userId').textContent = email;
      document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'inline-block';
      document.getElementById('statsGrid').style.display = 'grid';
      document.getElementById('loginForm').classList.remove('show');
    }

    // ğŸ” ä¿®å¤ç‰ˆï¼šåŠ è½½ç»Ÿè®¡æ•°æ®ï¼ˆç¡®ä¿åªåŠ è½½å½“å‰ç”¨æˆ·çš„è®¢å•ï¼‰
    async function loadStats() {
      // ğŸ” å…³é”®ï¼šå¿…é¡»å…ˆç¡®è®¤ç”¨æˆ·å·²ç™»å½•
      if (!currentUser || !currentUser.id) {
        console.warn('âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡åŠ è½½ç»Ÿè®¡');
        return;
      }

      try {
        // ğŸ” å…³é”®ï¼šä½¿ç”¨ eq('user_id', currentUser.id) ä¸¥æ ¼è¿‡æ»¤
        // ğŸ” å¹¶ä¸”åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œé¿å…æƒé™é—®é¢˜
        const { data, error } = await db
          .from('orders')
          .select('total, status, discount')
          .eq('user_id', currentUser.id)  // ğŸ”´ å¿…é¡»è¿‡æ»¤å½“å‰ç”¨æˆ·
          .order('created_at', { ascending: false });

        if (error) {
          console.error('åŠ è½½è®¢å•ç»Ÿè®¡å¤±è´¥:', error);
          // å¦‚æœæ˜¯æƒé™é”™è¯¯ï¼Œå¯èƒ½æ˜¯ RLS æœªé…ç½®
          if (error.code === '42501') {
            console.warn('âš ï¸ å¯èƒ½æ˜¯ Row Level Security æœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
          }
          return;
        }

        if (!data || data.length === 0) {
          // æ²¡æœ‰è®¢å•ï¼Œæ˜¾ç¤º 0
          document.getElementById('statOrders').textContent = '0';
          document.getElementById('statSpent').textContent = `${SITE_CONFIG?.currency || 'Â¥'}0.00`;
          document.getElementById('statSaved').textContent = `${SITE_CONFIG?.currency || 'Â¥'}0.00`;
          return;
        }

        // ğŸ” å†æ¬¡åœ¨å®¢æˆ·ç«¯è¿‡æ»¤ï¼ˆåŒé‡ä¿é™©ï¼‰
        const userOrders = data.filter(order => order.user_id === currentUser.id);
        const completedOrders = userOrders.filter(o => o.status === 'completed');
        
        const totalOrders = completedOrders.length;
        const totalSpent = completedOrders.reduce((sum, o) => sum + (o.total || 0), 0);
        const totalSaved = userOrders.reduce((sum, o) => sum + (o.discount || 0), 0);

        document.getElementById('statOrders').textContent = totalOrders;
        document.getElementById('statSpent').textContent = `${SITE_CONFIG?.currency || 'Â¥'}${totalSpent.toFixed(2)}`;
        document.getElementById('statSaved').textContent = `${SITE_CONFIG?.currency || 'Â¥'}${totalSaved.toFixed(2)}`;

        console.log(`âœ… åŠ è½½ç»Ÿè®¡æˆåŠŸï¼š${totalOrders} ä¸ªè®¢å•ï¼Œæ€»è®¡ Â¥${totalSpent.toFixed(2)}`);

      } catch (err) {
        console.error('åŠ è½½ç»Ÿè®¡å¼‚å¸¸:', err);
        // é™é»˜å¤±è´¥ï¼Œä¸å½±å“é¡µé¢ä½¿ç”¨
      }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    window.showComingSoon = function() {
      showToast('ğŸš§ åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼', 'error');
    };

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', initPage);

    // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶
    window.addEventListener('languageChanged', () => {
      if (typeof applyLanguage === 'function') {
        applyLanguage();
      }
    });
  </script>
</body>
</html>