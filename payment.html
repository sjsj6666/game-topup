<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="seo.payment.title">æ”¯ä»˜ç¡®è®¤ - GameTopUp</title>
  <meta name="description" data-i18n="seo.payment.desc" content="å®‰å…¨æ”¯ä»˜ï¼Œæ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="translations.js"></script>
  <script src="i18n.js"></script>
  <script src="seo-loader.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-color: #6C63FF;
      --secondary-color: #FF6584;
      --success-color: #28A745;
      --bg-color: #F8F9FA;
      --card-bg: #FFFFFF;
      --text-dark: #333;
      --text-light: #666;
    }
    [data-theme="dark"] {
      --bg-color: #1A1A2E;
      --card-bg: #16213E;
      --text-dark: #E8E8E8;
      --text-light: #A0A0A0;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-dark); padding-bottom: 80px; }
    .container { max-width: 600px; margin: 0 auto; padding: 0 15px; }
    .header { background: var(--card-bg); padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header-content { display: flex; align-items: center; justify-content: space-between; }
    .back-btn { background: none; border: none; font-size: 1rem; color: var(--text-dark); cursor: pointer; }
    .page-title { font-size: 1.2rem; font-weight: 700; }
    .order-section { background: var(--card-bg); border-radius: 16px; padding: 20px; margin: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .section-title { font-size: 1rem; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .order-item { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .order-label { color: var(--text-light); }
    .order-value { font-weight: 600; }
    .order-total { margin-top: 15px; padding-top: 15px; border-top: 2px dashed #eee; display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
    .payment-methods { display: flex; flex-direction: column; gap: 12px; }
    .payment-option { background: var(--card-bg); border: 2px solid #eee; border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: all 0.3s; }
    .payment-option:hover { border-color: var(--primary-color); }
    .payment-option.selected { border-color: var(--primary-color); background-color: rgba(108, 99, 255, 0.05); }
    .payment-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .payment-icon.alipay { background: #1677FF; color: white; }
    .payment-icon.wechat { background: #07C160; color: white; }
    .payment-icon.paypal { background: #003087; color: white; }
    .payment-info { flex: 1; }
    .payment-name { font-weight: 600; margin-bottom: 3px; }
    .payment-desc { font-size: 0.8rem; color: var(--text-light); }
    .payment-check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; }
    .payment-option.selected .payment-check { background: var(--primary-color); border-color: var(--primary-color); color: white; }
    .account-section { background: var(--card-bg); border-radius: 16px; padding: 20px; margin: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .input-group { margin-bottom: 15px; }
    .input-label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-dark); }
    .input-field { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; outline: none; background: var(--card-bg); color: var(--text-dark); }
    .input-field:focus { border-color: var(--primary-color); }
    .input-hint { font-size: 0.8rem; color: var(--text-light); margin-top: 5px; }
    .coupon-section { background: var(--card-bg); border-radius: 16px; padding: 20px; margin: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .coupon-input-group { display: flex; gap: 10px; margin-top: 10px; }
    .coupon-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; background: var(--card-bg); color: var(--text-dark); }
    .coupon-btn { padding: 12px 20px; background: var(--secondary-color); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
    .coupon-result { margin-top: 10px; padding: 10px; border-radius: 12px; font-size: 0.9rem; display: none; }
    .coupon-result.success { background: #e8f5e9; color: #2e7d32; display: block; }
    .coupon-result.error { background: #ffebee; color: #c62828; display: block; }
    .pay-footer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .pay-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
    .pay-btn:disabled { background: #ccc; cursor: not-allowed; }
    .success-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .success-overlay.show { opacity: 1; pointer-events: auto; }
    .success-content { background: var(--card-bg); border-radius: 16px; padding: 40px; text-align: center; max-width: 90%; }
    .success-icon { width: 80px; height: 80px; background: var(--success-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2.5rem; color: white; }
    .success-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="container header-content">
      <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
      <div class="page-title" data-i18n="payment.title">ç¡®è®¤æ”¯ä»˜</div>
      <div style="width: 36px;"></div>
    </div>
  </header>

  <div class="container">
    <div class="order-section">
      <div class="section-title" data-i18n="payment.order.title">ğŸ“¦ è®¢å•ä¿¡æ¯</div>
      <div class="order-item">
        <span class="order-label" data-i18n="payment.order.id">è®¢å•ç¼–å·</span>
        <span class="order-value" id="orderId">-</span>
      </div>
      <div class="order-item">
        <span class="order-label" data-i18n="payment.order.item">å•†å“åç§°</span>
        <span class="order-value" id="itemName">-</span>
      </div>
      <div class="order-item">
        <span class="order-label" data-i18n="payment.order.package">å¥—é¤å†…å®¹</span>
        <span class="order-value" id="packageInfo">-</span>
      </div>
      <div class="order-item">
        <span class="order-label" data-i18n="payment.order.quantity">è´­ä¹°æ•°é‡</span>
        <span class="order-value" id="quantity">-</span>
      </div>
      <div class="order-item">
        <span class="order-label" data-i18n="payment.order.original">åŸä»·</span>
        <span class="order-value" id="originalAmount">Â¥0.00</span>
      </div>
      <div class="order-item" id="discountRow" style="display: none;">
        <span class="order-label" data-i18n="payment.order.discount">ä¼˜æƒ æŠ˜æ‰£</span>
        <span class="order-value" style="color: var(--success-color);" id="discountAmount">-Â¥0.00</span>
      </div>
      <div class="order-total">
        <span data-i18n="payment.total">åº”ä»˜æ€»é¢</span>
        <span id="totalAmount">Â¥0.00</span>
      </div>
    </div>

    <div class="coupon-section">
      <div class="section-title" data-i18n="payment.coupon.title">ğŸ« ä¼˜æƒ åˆ¸</div>
      <div class="coupon-input-group">
        <input type="text" class="coupon-input" id="couponCode" data-i18n="payment.coupon.placeholder" placeholder="è¾“å…¥ä¼˜æƒ ç ">
        <button class="coupon-btn" onclick="applyCoupon()" data-i18n="payment.coupon.apply">ä½¿ç”¨</button>
      </div>
      <div class="coupon-result" id="couponResult"></div>
      <div style="margin-top: 10px; font-size: 0.8rem; color: var(--text-light);" data-i18n="payment.coupon.hint">ğŸ’¡ å¯ç”¨ä¼˜æƒ ç ï¼šNEW2026 (9 æŠ˜) | VIP50 (å‡Â¥50) | FIRST (å‡Â¥10)</div>
    </div>

    <div class="order-section">
      <div class="section-title" data-i18n="payment.payment.title">ğŸ’³ é€‰æ‹©æ”¯ä»˜æ–¹å¼</div>
      <div class="payment-methods">
        <div class="payment-option selected" data-method="alipay" onclick="selectPayment(this)">
          <div class="payment-icon alipay"><i class="fab fa-alipay"></i></div>
          <div class="payment-info">
            <div class="payment-name" data-i18n="payment.payment.alipay">æ”¯ä»˜å®</div>
            <div class="payment-desc" data-i18n="payment.payment.alipay.desc">æ¨èä½¿ç”¨ï¼Œç§’é€Ÿåˆ°è´¦</div>
          </div>
          <div class="payment-check"><i class="fas fa-check"></i></div>
        </div>
        <div class="payment-option" data-method="wechat" onclick="selectPayment(this)">
          <div class="payment-icon wechat"><i class="fab fa-weixin"></i></div>
          <div class="payment-info">
            <div class="payment-name" data-i18n="payment.payment.wechat">å¾®ä¿¡æ”¯ä»˜</div>
            <div class="payment-desc" data-i18n="payment.payment.wechat.desc">æ–¹ä¾¿å¿«æ·ï¼Œå®‰å…¨å¯é </div>
          </div>
          <div class="payment-check"><i class="fas fa-check"></i></div>
        </div>
        <div class="payment-option" data-method="paypal" onclick="selectPayment(this)">
          <div class="payment-icon paypal"><i class="fab fa-paypal"></i></div>
          <div class="payment-info">
            <div class="payment-name" data-i18n="payment.payment.paypal">PayPal</div>
            <div class="payment-desc" data-i18n="payment.payment.paypal.desc">å›½é™…æ”¯ä»˜é¦–é€‰</div>
          </div>
          <div class="payment-check"><i class="fas fa-check"></i></div>
        </div>
      </div>
    </div>

    <div class="account-section">
      <div class="section-title" data-i18n="payment.account.title">ğŸ‘¤ å……å€¼è´¦å·</div>
      <div class="input-group">
        <label class="input-label" data-i18n="payment.account.label">æ¸¸æˆè´¦å· / UID</label>
        <input type="text" class="input-field" id="gameAccount" data-i18n="payment.account.placeholder" placeholder="è¯·è¾“å…¥æ‚¨çš„æ¸¸æˆè´¦å·">
        <div class="input-hint" data-i18n="payment.account.hint">âš ï¸ è¯·ä»”ç»†æ ¸å¯¹ï¼Œå……å€¼åæ— æ³•ä¿®æ”¹</div>
      </div>
      <div class="input-group">
        <label class="input-label" data-i18n="payment.account.confirm">ç¡®è®¤è´¦å·</label>
        <input type="text" class="input-field" id="confirmAccount" placeholder="å†æ¬¡è¾“å…¥æ¸¸æˆè´¦å·">
      </div>
    </div>
  </div>

  <div class="pay-footer">
    <button class="pay-btn" id="payBtn" onclick="processPayment()" data-i18n="payment.btn">ç«‹å³æ”¯ä»˜</button>
  </div>

  <div class="success-overlay" id="successOverlay">
    <div class="success-content">
      <div class="success-icon"><i class="fas fa-check"></i></div>
      <div class="success-title" data-i18n="payment.success.title">æ”¯ä»˜æˆåŠŸï¼</div>
      <div style="color: var(--text-light); margin-bottom: 20px;" data-i18n="payment.success.desc">é¢„è®¡ 1-5 åˆ†é’Ÿåˆ°è´¦</div>
      <button onclick="window.location.href='orders.html'" style="padding: 12px 40px; background: var(--primary-color); color: white; border: none; border-radius: 25px; cursor: pointer;" data-i18n="payment.success.btn">æŸ¥çœ‹è®¢å•</button>
    </div>
  </div>

  <script>
    let orderData = null;
    let selectedPayment = 'alipay';
    let appliedCoupon = null;
    let originalTotal = 0;
    let discountAmount = 0;

    function loadOrder() {
      let cart = sessionStorage.getItem('cartCheckout');
      if (cart) {
        cart = JSON.parse(cart);
        orderData = {
          items: cart,
          total: cart.reduce((sum, item) => sum + item.package.price * item.quantity, 0),
          orderId: 'ORD' + Date.now()
        };
      } else {
        cart = sessionStorage.getItem('pendingOrder');
        if (cart) orderData = JSON.parse(cart);
      }

      if (!orderData) { alert('âš ï¸ æ²¡æœ‰å¾…æ”¯ä»˜çš„è®¢å•'); window.location.href = 'index.html'; return; }

      originalTotal = orderData.total;
      document.getElementById('orderId').textContent = orderData.orderId;
      const firstItem = orderData.items ? orderData.items[0] : orderData;
      document.getElementById('itemName').textContent = firstItem.gameName || firstItem.game || 'æ¸¸æˆå……å€¼';
      document.getElementById('packageInfo').textContent = firstItem.package?.name || 'å¥—é¤';
      document.getElementById('quantity').textContent = `Ã—${firstItem.quantity || 1}`;
      document.getElementById('originalAmount').textContent = `${SITE_CONFIG?.currency || 'Â¥'}${originalTotal.toFixed(2)}`;
      updateTotalDisplay();
    }

    window.selectPayment = function(element) {
      document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
      element.classList.add('selected');
      selectedPayment = element.dataset.method;
    };

    window.applyCoupon = async function() {
      const code = document.getElementById('couponCode').value.trim().toUpperCase();
      const resultEl = document.getElementById('couponResult');

      if (!code) { resultEl.className = 'coupon-result error'; resultEl.textContent = 'âš ï¸ è¯·è¾“å…¥ä¼˜æƒ ç '; return; }

      try {
        const { data, error } = await db.from('coupons').select('*').eq('code', code).eq('active', true).single();
        if (error || !data) { resultEl.className = 'coupon-result error'; resultEl.textContent = 'âŒ ä¼˜æƒ ç æ— æ•ˆæˆ–å·²è¿‡æœŸ'; appliedCoupon = null; discountAmount = 0; updateTotalDisplay(); return; }
        if (originalTotal < data.min_order) { resultEl.className = 'coupon-result error'; resultEl.textContent = `âš ï¸ è®¢å•æ»¡${SITE_CONFIG?.currency || 'Â¥'}${data.min_order}æ‰å¯ä½¿ç”¨`; appliedCoupon = null; discountAmount = 0; updateTotalDisplay(); return; }

        if (data.type === 'percent') discountAmount = originalTotal * (1 - data.value);
        else discountAmount = data.value;
        if (discountAmount > originalTotal) discountAmount = originalTotal;

        appliedCoupon = { code: data.code, ...data };
        resultEl.className = 'coupon-result success';
        resultEl.textContent = `âœ… ä¼˜æƒ æˆåŠŸï¼${data.description}ï¼ŒèŠ‚çœ${SITE_CONFIG?.currency || 'Â¥'}${discountAmount.toFixed(2)}`;
        updateTotalDisplay();
      } catch (err) {
        console.error('ä¼˜æƒ åˆ¸éªŒè¯å¤±è´¥:', err);
        resultEl.className = 'coupon-result error';
        resultEl.textContent = 'âŒ éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•';
      }
    };

    function updateTotalDisplay() {
      const finalTotal = originalTotal - discountAmount;
      document.getElementById('totalAmount').textContent = `${SITE_CONFIG?.currency || 'Â¥'}${finalTotal.toFixed(2)}`;
      if (discountAmount > 0) {
        document.getElementById('discountRow').style.display = 'flex';
        document.getElementById('discountAmount').textContent = `-${SITE_CONFIG?.currency || 'Â¥'}${discountAmount.toFixed(2)}`;
      } else {
        document.getElementById('discountRow').style.display = 'none';
      }
    }

    window.processPayment = async function() {
      const gameAccount = document.getElementById('gameAccount').value.trim();
      const confirmAccount = document.getElementById('confirmAccount').value.trim();

      if (!gameAccount) { alert('âš ï¸ è¯·è¾“å…¥æ¸¸æˆè´¦å·'); return; }
      if (gameAccount !== confirmAccount) { alert('âš ï¸ ä¸¤æ¬¡è¾“å…¥çš„è´¦å·ä¸ä¸€è‡´'); return; }
      if (gameAccount.length < 5) { alert('âš ï¸ è´¦å·æ ¼å¼ä¸æ­£ç¡®'); return; }

      const payBtn = document.getElementById('payBtn');
      payBtn.disabled = true;
      payBtn.innerHTML = '<div style="width:20px;height:20px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;"></div> å¤„ç†ä¸­...';

      try {
        const finalTotal = originalTotal - discountAmount;
        const firstItem = orderData.items ? orderData.items[0] : orderData;

        const orderToSave = {
          id: orderData.orderId,
          user_id: null,
          game_id: firstItem?.gameId || firstItem?.game || 'unknown',
          package_id: firstItem?.package?.id || null,
          quantity: firstItem?.quantity || 1,
          total: finalTotal,
          discount: discountAmount,
          coupon_code: appliedCoupon?.code || null,
          payment_method: selectedPayment,
          game_account: gameAccount,
          status: 'completed',
          paid_at: new Date().toISOString(),
          created_at: new Date().toISOString()
        };

        const { data, error } = await db.from('orders').insert([orderToSave]).select();
        if (error) throw error;

        localStorage.removeItem('gameTopUpCart');
        sessionStorage.removeItem('cartCheckout');
        sessionStorage.removeItem('pendingOrder');

        document.getElementById('successOrder').textContent = `è®¢å•å·ï¼š${orderData.orderId}`;
        document.getElementById('successOverlay').classList.add('show');
      } catch (err) {
        console.error('æ”¯ä»˜å¤±è´¥:', err);
        alert('âŒ æ”¯ä»˜å¤±è´¥ï¼š' + err.message);
        payBtn.disabled = false;
        payBtn.textContent = 'ç«‹å³æ”¯ä»˜';
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadOrder();
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
    });
  </script>
</body>
</html>