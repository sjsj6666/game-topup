<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ”¯ä»˜ç¡®è®¤ - GameTopUp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-color: #6C63FF;
      --secondary-color: #FF6584;
      --success-color: #28A745;
      --light-color: #F8F9FA;
      --text-dark: #333;
      --text-light: #666;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --radius-md: 12px;
      --radius-lg: 16px;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--light-color);
      color: var(--text-dark);
      padding-bottom: 80px;
    }
    .container { max-width: 600px; margin: 0 auto; padding: 0 15px; }

    /* å¤´éƒ¨ */
    .header {
      background: white;
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow-sm);
    }
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .back-btn {
      background: none; border: none; font-size: 1rem;
      color: var(--text-dark); cursor: pointer;
    }
    .page-title { font-size: 1.2rem; font-weight: 700; }

    /* è®¢å•ä¿¡æ¯ */
    .order-section {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      margin: 20px;
      box-shadow: var(--shadow-sm);
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .order-label { color: var(--text-light); }
    .order-value { font-weight: 600; }
    .order-total {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px dashed #eee;
      display: flex;
      justify-content: space-between;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    /* æ”¯ä»˜æ–¹å¼ */
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .payment-option {
      background: white;
      border: 2px solid #eee;
      border-radius: var(--radius-md);
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .payment-option:hover { border-color: var(--primary-color); }
    .payment-option.selected {
      border-color: var(--primary-color);
      background-color: rgba(108, 99, 255, 0.05);
    }
    .payment-icon {
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
    }
    .payment-icon.alipay { background: #1677FF; color: white; }
    .payment-icon.wechat { background: #07C160; color: white; }
    .payment-icon.paypal { background: #003087; color: white; }
    .payment-info { flex: 1; }
    .payment-name { font-weight: 600; margin-bottom: 3px; }
    .payment-desc { font-size: 0.8rem; color: var(--text-light); }
    .payment-check {
      width: 24px; height: 24px;
      border-radius: 50%;
      border: 2px solid #ddd;
      display: flex; align-items: center; justify-content: center;
    }
    .payment-option.selected .payment-check {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    /* è´¦å·è¾“å…¥ */
    .account-section {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      margin: 20px;
      box-shadow: var(--shadow-sm);
    }
    .input-group { margin-bottom: 15px; }
    .input-label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-dark);
    }
    .input-field {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--radius-md);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s;
    }
    .input-field:focus { border-color: var(--primary-color); }
    .input-hint {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-top: 5px;
    }

    /* å®‰å…¨æç¤º */
    .security-notice {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: var(--radius-md);
      padding: 12px 15px;
      margin: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: #856404;
    }

    /* åº•éƒ¨æ”¯ä»˜æŒ‰é’® */
    .pay-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 15px 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .pay-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--primary-color), #36D1DC);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
      transition: all 0.3s;
    }
    .pay-btn:hover { transform: translateY(-2px); }
    .pay-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* æ”¯ä»˜æˆåŠŸåŠ¨ç”» */
    .success-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .success-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    .success-content {
      background: white;
      border-radius: var(--radius-lg);
      padding: 40px;
      text-align: center;
      max-width: 90%;
      animation: popIn 0.4s ease-out;
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .success-icon {
      width: 80px; height: 80px;
      background: var(--success-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 2.5rem;
      color: white;
    }
    .success-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .success-order {
      color: var(--text-light);
      margin-bottom: 20px;
    }
    .success-btn {
      padding: 12px 40px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
    }

    /* åŠ è½½ä¸­ */
    .loading-spinner {
      width: 40px; height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- å¤´éƒ¨ -->
  <header class="header">
    <div class="container header-content">
      <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i></button>
      <div class="page-title">ç¡®è®¤æ”¯ä»˜</div>
      <div style="width: 40px;"></div>
    </div>
  </header>

  <!-- è®¢å•ä¿¡æ¯ -->
  <div class="container">
    <div class="order-section">
      <div class="section-title">ğŸ“¦ è®¢å•ä¿¡æ¯</div>
      <div class="order-item">
        <span class="order-label">è®¢å•ç¼–å·</span>
        <span class="order-value" id="orderId">-</span>
      </div>
      <div class="order-item">
        <span class="order-label">å•†å“åç§°</span>
        <span class="order-value" id="itemName">-</span>
      </div>
      <div class="order-item">
        <span class="order-label">å¥—é¤å†…å®¹</span>
        <span class="order-value" id="packageInfo">-</span>
      </div>
      <div class="order-item">
        <span class="order-label">è´­ä¹°æ•°é‡</span>
        <span class="order-value" id="quantity">-</span>
      </div>
      <div class="order-total">
        <span>åº”ä»˜æ€»é¢</span>
        <span id="totalAmount">Â¥0.00</span>
      </div>
    </div>

    <!-- æ”¯ä»˜æ–¹å¼ -->
    <div class="order-section">
      <div class="section-title">ğŸ’³ é€‰æ‹©æ”¯ä»˜æ–¹å¼</div>
      <div class="payment-methods">
        <div class="payment-option selected" data-method="alipay">
          <div class="payment-icon alipay"><i class="fab fa-alipay"></i></div>
          <div class="payment-info">
            <div class="payment-name">æ”¯ä»˜å®</div>
            <div class="payment-desc">æ¨èä½¿ç”¨ï¼Œç§’é€Ÿåˆ°è´¦</div>
          </div>
          <div class="payment-check"><i class="fas fa-check"></i></div>
        </div>
        <div class="payment-option" data-method="wechat">
          <div class="payment-icon wechat"><i class="fab fa-weixin"></i></div>
          <div class="payment-info">
            <div class="payment-name">å¾®ä¿¡æ”¯ä»˜</div>
            <div class="payment-desc">æ–¹ä¾¿å¿«æ·ï¼Œå®‰å…¨å¯é </div>
          </div>
          <div class="payment-check"><i class="fas fa-check"></i></div>
        </div>
        <div class="payment-option" data-method="paypal">
          <div class="payment-icon paypal"><i class="fab fa-paypal"></i></div>
          <div class="payment-info">
            <div class="payment-name">PayPal</div>
            <div class="payment-desc">å›½é™…æ”¯ä»˜é¦–é€‰</div>
          </div>
          <div class="payment-check"><i class="fas fa-check"></i></div>
        </div>
      </div>
    </div>

    <!-- è´¦å·è¾“å…¥ -->
    <div class="account-section">
      <div class="section-title">ğŸ‘¤ å……å€¼è´¦å·</div>
      <div class="input-group">
        <label class="input-label">æ¸¸æˆè´¦å· / UID</label>
        <input type="text" class="input-field" id="gameAccount" placeholder="è¯·è¾“å…¥æ‚¨çš„æ¸¸æˆè´¦å·">
        <div class="input-hint">âš ï¸ è¯·ä»”ç»†æ ¸å¯¹ï¼Œå……å€¼åæ— æ³•ä¿®æ”¹</div>
      </div>
      <div class="input-group">
        <label class="input-label">ç¡®è®¤è´¦å·</label>
        <input type="text" class="input-field" id="confirmAccount" placeholder="å†æ¬¡è¾“å…¥æ¸¸æˆè´¦å·">
      </div>
    </div>

    <!-- å®‰å…¨æç¤º -->
    <div class="security-notice">
      <i class="fas fa-shield-alt"></i>
      <div>
        <strong>å®‰å…¨æ”¯ä»˜ä¿éšœ</strong><br>
        æ‚¨çš„æ”¯ä»˜ä¿¡æ¯å·²åŠ å¯†ï¼Œæœ¬å¹³å°ä¸ä¼šå­˜å‚¨æ‚¨çš„æ”¯ä»˜å¯†ç 
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨æ”¯ä»˜æŒ‰é’® -->
  <div class="pay-footer">
    <button class="pay-btn" id="payBtn">ç«‹å³æ”¯ä»˜</button>
  </div>

  <!-- æ”¯ä»˜æˆåŠŸå¼¹çª— -->
  <div class="success-overlay" id="successOverlay">
    <div class="success-content">
      <div class="success-icon"><i class="fas fa-check"></i></div>
      <div class="success-title">æ”¯ä»˜æˆåŠŸï¼</div>
      <div class="success-order" id="successOrder">è®¢å•å·ï¼šORD123456</div>
      <div style="color: var(--success-color); margin-bottom: 20px;">
        <i class="fas fa-clock"></i> é¢„è®¡ 1-5 åˆ†é’Ÿåˆ°è´¦
      </div>
      <button class="success-btn" id="toOrdersBtn">æŸ¥çœ‹è®¢å•</button>
    </div>
  </div>

  <script>
    // ğŸ”§ å®‰å…¨è·å– localStorage
    function safeGetStorage(key, defaultValue) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
      } catch (e) { return defaultValue; }
    }

    function safeSetStorage(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (e) { return false; }
    }

    // è®¢å•æ•°æ®
    let orderData = null;
    let selectedPayment = 'alipay';

    // åˆå§‹åŒ–
    function initPage() {
      // ä» sessionStorage è·å–å¾…æ”¯ä»˜è®¢å•
      orderData = sessionStorage.getItem('pendingOrder');
      
      if (!orderData) {
        // å¦‚æœæ²¡æœ‰å¾…æ”¯ä»˜è®¢å•ï¼Œä»è´­ç‰©è½¦åˆ›å»º
        const cart = safeGetStorage('gameTopUpCart', []);
        if (cart.length === 0) {
          alert('âš ï¸ æ²¡æœ‰å¾…æ”¯ä»˜çš„è®¢å•');
          window.location.href = 'index.html';
          return;
        }
        // ä½¿ç”¨ç¬¬ä¸€ä¸ªå•†å“ä½œä¸ºè®¢å•
        orderData = {
          items: cart,
          total: cart.reduce((sum, item) => sum + item.package.price * item.quantity, 0),
          orderId: 'ORD' + Date.now()
        };
      } else {
        orderData = JSON.parse(orderData);
      }

      // å¡«å……è®¢å•ä¿¡æ¯
      document.getElementById('orderId').textContent = orderData.orderId;
      
      // å•†å“åç§°ï¼ˆå–ç¬¬ä¸€ä¸ªï¼‰
      const firstItem = orderData.items[0];
      document.getElementById('itemName').textContent = firstItem.game;
      document.getElementById('packageInfo').textContent = firstItem.package.name;
      document.getElementById('quantity').textContent = `Ã—${firstItem.quantity}`;
      document.getElementById('totalAmount').textContent = `Â¥${orderData.total.toFixed(2)}`;

      // æ”¯ä»˜æ–¹å¼é€‰æ‹©
      document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          selectedPayment = option.dataset.method;
        });
      });

      // æ”¯ä»˜æŒ‰é’®
      document.getElementById('payBtn').addEventListener('click', processPayment);

      // è¿”å›æŒ‰é’®
      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = 'cart.html';
      });

      // æŸ¥çœ‹è®¢å•æŒ‰é’®
      document.getElementById('toOrdersBtn').addEventListener('click', () => {
        window.location.href = 'orders.html';
      });
    }

    // å¤„ç†æ”¯ä»˜
    function processPayment() {
      const gameAccount = document.getElementById('gameAccount').value.trim();
      const confirmAccount = document.getElementById('confirmAccount').value.trim();

      // éªŒè¯
      if (!gameAccount) {
        alert('âš ï¸ è¯·è¾“å…¥æ¸¸æˆè´¦å·');
        return;
      }
      if (gameAccount !== confirmAccount) {
        alert('âš ï¸ ä¸¤æ¬¡è¾“å…¥çš„è´¦å·ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥');
        return;
      }
      if (gameAccount.length < 5) {
        alert('âš ï¸ è´¦å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥åé‡è¯•');
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const payBtn = document.getElementById('payBtn');
      payBtn.disabled = true;
      payBtn.innerHTML = '<div class="loading-spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto;"></div> å¤„ç†ä¸­...';

      // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†ï¼ˆ2 ç§’å»¶è¿Ÿï¼‰
      setTimeout(() => {
        // ä¿å­˜å®Œæ•´è®¢å•
        orderData.gameAccount = gameAccount;
        orderData.paymentMethod = selectedPayment;
        orderData.status = 'completed';
        orderData.payTime = new Date().toISOString();

        let orders = safeGetStorage('gameTopUpOrders', []);
        orders.unshift(orderData); // æ·»åŠ åˆ°å¼€å¤´
        safeSetStorage('gameTopUpOrders', orders);

        // æ¸…ç©ºè´­ç‰©è½¦
        safeSetStorage('gameTopUpCart', []);

        // æ˜¾ç¤ºæˆåŠŸåŠ¨ç”»
        document.getElementById('successOrder').textContent = `è®¢å•å·ï¼š${orderData.orderId}`;
        document.getElementById('successOverlay').classList.add('show');

        // æ¢å¤æŒ‰é’®
        payBtn.disabled = false;
        payBtn.textContent = 'ç«‹å³æ”¯ä»˜';
      }, 2000);
    }

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>